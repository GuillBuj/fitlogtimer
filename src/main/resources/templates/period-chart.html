<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <title>Progression</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

</head>
<body>
<div th:insert="~{fragments/navbar :: navbar}"></div>
<div class="header-container">
    <h2>Maxs</h2>
</div>

<div id="periodChartContainer">
    <canvas id="periodChart"></canvas>
</div>

<div style="margin: 20px;">
    <input type="range" id="zoomSlider" min="12" max="36" value="24" step="1">
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const chartData = /*[[${chartData}]]*/ [];

    const exercises = [...new Set(chartData.map(d => d.exerciseName))];
    const periods = [...new Set(chartData.map(d => d.period))].sort();

    const colors = [
        'rgba(54, 162, 235, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 99, 132, 0.7)'
    ];

    const datasets = exercises.map((exercise, idx) => {
        const exerciseData = chartData.filter(d => d.exerciseName === exercise);
        return {
            label: exercise,
            data: periods.map(p => {
                const dp = exerciseData.find(d => d.period === p);
                return dp ? dp.max : null;
            }),
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length],
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 4
        };
    });

    // Convertir en Date (premier jour du mois ou lundi de la semaine)
    const labelsAsDates = periods.map(p => {
        if (p.includes("W")) { // semaine
            const [year, week] = p.split("-W").map(Number);
            return new Date(year, 0, 1 + (week - 1) * 7);
        } else { // mois
            const [year, month] = p.split("-").map(Number);
            return new Date(year, month - 1, 1);
        }
    }).sort((a, b) => a - b); // Tri des dates

    // Calculer les dates limites
    const minDateOverall = labelsAsDates[0];
    const maxDateOverall = labelsAsDates[labelsAsDates.length - 1];

    // Calculer la durée totale disponible en mois
    const totalMonths = (maxDateOverall.getFullYear() - minDateOverall.getFullYear()) * 12
        + (maxDateOverall.getMonth() - minDateOverall.getMonth()) + 1;

    // Ajuster dynamiquement les limites du slider
    const MIN_ZOOM = 12; // Zoom max : 12 derniers mois
    const MAX_ZOOM = Math.max(totalMonths, MIN_ZOOM); // Dézoom max : toutes les données
    const INITIAL_ZOOM = Math.min(24, MAX_ZOOM); // Initial : 24 mois ou moins

    const ctx = document.getElementById('periodChart');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsAsDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'month' },
                    title: { display: true, text: 'Période' }
                },
                y: {
                    beginAtZero: false,
                    title: { display: true, text: 'Poids (kg)' }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { usePointStyle: true }
                }
            }
        }
    });

    // --- Gestion du slider ---
    function updateZoom(months) {
        const lastDate = maxDateOverall;
        const minDate = new Date(lastDate);
        minDate.setMonth(minDate.getMonth() - months + 1); // +1 pour inclure le mois courant

        // S'assurer qu'on ne dépasse pas la date minimale globale
        const effectiveMinDate = minDate < minDateOverall ? minDateOverall : minDate;

        chart.options.scales.x.min = effectiveMinDate;
        chart.options.scales.x.max = lastDate;
        chart.update();
    }

    // Initialisation dynamique du slider
    const zoomSlider = document.getElementById('zoomSlider');
    zoomSlider.min = MIN_ZOOM;
    zoomSlider.max = MAX_ZOOM;
    zoomSlider.value = INITIAL_ZOOM;

    // Init (24 mois par défaut, ou moins si moins de données)
    updateZoom(INITIAL_ZOOM);

    document.getElementById('zoomSlider').addEventListener('input', (e) => {
        const months = parseInt(e.target.value, 10);
        updateZoom(months);
    });
    /*]]>*/
</script>